<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeRuaD - Favourite Tracks</title>
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/favourite.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body class="text-light">
    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-brand rgb-glow">
                <span class="brand-mark">NeRuaD</span>
                <small class="muted">Favourites</small>
            </div>
            <nav class="sidebar-nav">
                <a class="nav-link" href="../../index.html">Home</a>
                <a class="nav-link active" href="favourite.html">Favourites</a>
                <a class="nav-link" href="profile.html">Profile</a>
            </nav>
            <div class="sidebar-section">
                <div class="sidebar-title">Quick Actions</div>
                <button class="sidebar-pill">Play All</button>
                <button class="sidebar-pill">Share Capsule</button>
            </div>
            <div class="sidebar-footer">
                <span class="badge-soft">Saved tracks</span>
            </div>
        </aside>

        <div class="main-panel">
            <header class="topbar">
                <h3 class="section-title mb-0">My Favourite Tracks</h3>
                <div class="topbar-actions">
                    <div class="btn-group">
                        <a class="btn btn-outline-secondary text-light" href="login.html">Login</a>
                        <a class="btn btn-warning" href="register.html">Sign Up</a>
                    </div>
                    <button id="themeToggle" class="btn btn-sm btn-outline-secondary" title="Toggle theme">üåì</button>
                </div>
            </header>

            <main>
                <div class="container" style="max-width: 1100px;">
                    <div class="playlist-block">
                        <div class="playlist-block-header">
                            <h4 class="mb-0">Your Playlists</h4>
                            <button class="btn btn-secondary btn-sm" id="createPlaylistFromFav">Create playlist</button>
                        </div>
                        <div id="playlistListInline" class="playlist-list-inline"></div>
                    </div>

                    <div id="favouritesList" class="track-list"></div>
                </div>
            </main>

            <footer class="app-footer">
                <div>NeRuaD</div>
                <div class="muted">Your saved tracks</div>
            </footer>
        </div>
    </div>

    <div class="player-bar bg-dark text-light border-top border-secondary fixed-bottom">
        <div class="player-container">
            <div class="player-track-info">
                <img id="playerAlbumArt" class="player-album-art" src="" alt="Album Art" style="display: none;">
                <div class="player-track-details">
                    <div id="playerTrackTitle" class="player-track-title">No track selected</div>
                    <div id="playerTrackArtist" class="player-track-artist">‚Äî</div>
                </div>
            </div>

            <div class="player-controls">
                <div class="player-buttons">
                    <button id="prevTrack" class="player-btn" title="Previous track">‚èÆ</button>
                    <button id="playPause" class="player-btn player-btn-main" title="Play/Pause">‚ñ∂</button>
                    <button id="nextTrack" class="player-btn" title="Next track">‚è≠</button>
                </div>
                <div class="player-progress-container">
                    <span id="currentTime" class="player-time">0:00</span>
                    <div class="player-progress-bar">
                        <div id="progressBar" class="player-progress-fill"></div>
                        <input type="range" id="progressSlider" class="player-progress-slider" min="0" max="100" value="0">
                    </div>
                    <span id="totalTime" class="player-time">0:00</span>
                </div>
            </div>

            <div class="player-volume">
                <button id="muteBtn" class="player-btn player-btn-small" title="Mute/Unmute">üîä</button>
                <div class="player-volume-bar">
                    <div id="volumeFill" class="player-volume-fill"></div>
                    <input type="range" id="volumeSlider" class="player-volume-slider" min="0" max="100" value="70">
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/api-client.js"></script>
    <script src="../js/favorites-manager.js"></script>
    <script src="../js/main.js"></script>
    <script src="../js/shared-ux.js"></script>
    <script src="../js/player.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        var audioMap = {
            mix1: '../src/music/track1.mp3',
            mix2: '../src/music/track2.mp3',
            mix3: '../src/music/track3.mp3',
            chill1: '../src/music/track4.mp3',
            rock1: '../src/music/track5.mp3',
            electronic1: '../src/music/track6.mp3',
            jazz1: '../src/music/jazz.mp3',
            hiphop1: '../src/music/hiphop.mp3',
            classical1: '../src/music/classical.mp3',
            indie1: '../src/music/indie.mp3',
            lofi1: '../src/music/lofi.mp3'
        };

        function normalizeAudioPath(path) {
            if (!path) return null;
            if (path.startsWith('frontend/')) {
                return '../' + path.replace(/^frontend\//, '');
            }
            if (path.startsWith('/frontend/')) {
                return '..' + path.replace(/^\/frontend/, '');
            }
            return path;
        }

        function resolveAudio(item) {
            if (item.audio) return normalizeAudioPath(item.audio);
            return audioMap[item.id] || null;
        }

        function formatDuration(seconds) {
            if (!seconds || isNaN(seconds)) return '‚Äî';
            var m = Math.floor(seconds / 60);
            var s = Math.floor(seconds % 60);
            return m + ':' + String(s).padStart(2, '0');
        }

        function applyDuration(audioSrc, durationEl, fallbackSeconds) {
            if (fallbackSeconds && fallbackSeconds > 0) {
                durationEl.textContent = formatDuration(fallbackSeconds);
                return;
            }
            if (!audioSrc) {
                durationEl.textContent = '‚Äî';
                return;
            }
            try {
                var audio = new Audio();
                audio.preload = 'metadata';
                audio.src = audioSrc;
                audio.addEventListener('loadedmetadata', function() {
                    durationEl.textContent = formatDuration(audio.duration);
                });
                audio.addEventListener('error', function() {
                    durationEl.textContent = '‚Äî';
                });
            } catch (e) {
                durationEl.textContent = '‚Äî';
            }
        }

        function getPlaylists() {
            try {
                return JSON.parse(localStorage.getItem('NeRuaD_playlists') || '[]');
            } catch (e) {
                return [];
            }
        }

        function renderPlaylistsInline() {
            var list = document.getElementById('playlistListInline');
            list.innerHTML = '';
            var playlists = getPlaylists();
            if (!playlists.length) {
                list.innerHTML = '<span class="muted">No playlists yet</span>';
                return;
            }
            playlists.forEach(function(pl) {
                var chip = document.createElement('a');
                chip.href = `playlists.html?id=${pl.id}`;
                chip.className = 'playlist-chip';
                chip.textContent = pl.name;
                list.appendChild(chip);
            });
        }

        function attachAudioHandlers(scope) {
            if (!scope) return;
            scope.addEventListener('click', function(event) {
                var img = event.target.closest('img[data-audio]');
                if (!img) return;

                var src = img.getAttribute('data-audio');
                var card = img.closest('.track-row');
                if (!src) return;

                if (window.currentAudio && window.currentAudio.src.includes(src)) {
                    window.currentAudio.pause();
                    window.currentAudio.currentTime = 0;
                    if (card) card.classList.remove('playing');
                    return;
                }

                if (window.currentAudio) {
                    window.currentAudio.pause();
                    window.currentAudio.currentTime = 0;
                }

                window.currentAudio = new Audio(src);
                const storedVolume = localStorage.getItem('NeRuaD_volume');
                window.currentAudio.volume = storedVolume ? parseFloat(storedVolume) / 100 : 0.7;
                window.currentAudio.play().catch(function(){});

                document.querySelectorAll('.track-row.playing').forEach(function(c){ c.classList.remove('playing'); });
                if (card) card.classList.add('playing');

                if (window.updatePlayerTrackInfo) {
                    window.updatePlayerTrackInfo(card);
                }
            });
        }

        if (!window.FavoritesManager || !window.FavoritesManager.isUserLoggedIn()) {
            var listEl = document.getElementById('favouritesList');
            var emptyWrap = document.createElement('div');
            emptyWrap.className = 'empty-state text-center';
            emptyWrap.innerHTML = `
                <div class="mb-3">
                    <i style="font-size: 3rem; color: #666;">üîí</i>
                </div>
                <h4>Login Required</h4>
                <p>Please login to view your favorite tracks</p>
                <a href="login.html" class="btn btn-warning">Login</a>
                <a href="register.html" class="btn btn-outline-secondary ms-2">Sign Up</a>
            `;
            listEl.parentNode.appendChild(emptyWrap);
            return;
        }

        renderPlaylistsInline();

        var list = window.FavoritesManager.readUserFavorites();
        var listEl = document.getElementById('favouritesList');
        listEl.innerHTML = '';

        if (!list.length) {
            var emptyWrap = document.createElement('div');
            emptyWrap.className = 'empty-state text-center';
            emptyWrap.innerHTML = `
                <div class="mb-3">
                    <i class="fas fa-heart" style="font-size: 3rem; color: #666;"></i>
                </div>
                <h4>No favourites yet</h4>
                <p>Start adding your favorite tracks from the home page!</p>
                <a href="../../index.html" class="btn btn-warning">Browse Music</a>
            `;
            listEl.parentNode.appendChild(emptyWrap);
            return;
        }

        list.forEach(function (item, index) {
            var row = document.createElement('div');
            row.className = 'track-row';
            row.setAttribute('data-title', item.title);

            var indexEl = document.createElement('div');
            indexEl.className = 'track-index';
            indexEl.textContent = String(index + 1).padStart(2, '0');

            var playIcon = document.createElement('div');
            playIcon.className = 'track-play';
            playIcon.textContent = '‚ñ∂';

            var img = document.createElement('img');
            img.className = 'track-cover';
            var safeImg = item.img || '';
            img.src = safeImg ? safeImg.replace('frontend/src/img/', '../src/img/') : '../src/img/track1.jpeg';
            img.alt = item.title;
            var audio = resolveAudio(item);
            if (audio) {
                img.setAttribute('data-audio', audio);
            }
            playIcon.addEventListener('click', function() {
                if (audio) {
                    img.click();
                }
            });

            var meta = document.createElement('div');
            meta.className = 'track-meta';
            var title = document.createElement('h4');
            title.textContent = item.title;
            var sub = document.createElement('p');
            sub.textContent = 'Favourite track';
            meta.appendChild(title);
            meta.appendChild(sub);

            var actions = document.createElement('div');
            actions.className = 'track-actions';

            var heartBtn = document.createElement('button');
            heartBtn.className = 'track-heart active';
            heartBtn.textContent = '‚ô•';

            var playBtn = document.createElement('button');
            playBtn.className = 'btn btn-play btn-sm';
            playBtn.textContent = 'Play';
            playBtn.addEventListener('click', function() {
                if (audio) {
                    img.click();
                }
            });

            var removeBtn = document.createElement('button');
            removeBtn.className = 'btn btn-outline-danger btn-sm';
            removeBtn.textContent = 'Remove';
            removeBtn.onclick = function() {
                removeFromFavorites(item.id);
            };

            actions.appendChild(heartBtn);
            actions.appendChild(playBtn);
            actions.appendChild(removeBtn);

            var duration = document.createElement('div');
            duration.className = 'track-duration';
            duration.textContent = '‚Äî';

            row.appendChild(indexEl);
            row.appendChild(playIcon);
            row.appendChild(img);
            row.appendChild(meta);
            row.appendChild(duration);
            row.appendChild(actions);
            listEl.appendChild(row);

            applyDuration(audio, duration, item.duration);
        });

        attachAudioHandlers(listEl);
        if (window.refreshTrackList) {
            window.refreshTrackList();
        }
    });

    function removeFromFavorites(itemId) {
        if (!window.FavoritesManager) return;

        const success = window.FavoritesManager.removeFromUserFavorites(itemId);

        if (success) {
            if (window.showNotification) {
                showNotification('Removed', 'Track removed from favorites', 'success', 2000);
            }

            setTimeout(function() {
                location.reload();
            }, 500);
        }
    }
    </script>
</body>
</html>
